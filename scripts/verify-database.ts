import { supabase } from '../lib/supabase'

async function testSupabaseConnection() {
  console.log('üîç Verificando conexi√≥n con Supabase...')
  
  try {
    // Test b√°sico de conexi√≥n
    const { data, error } = await supabase
      .from('users')
      .select('*')
      .limit(1)

    if (error) {
      if (error.message.includes('does not exist') || error.code === 'PGRST205') {
        console.log('‚ùå Las tablas no existen en Supabase')
        console.log('üìã Ve al SQL Editor de Supabase y ejecuta el siguiente c√≥digo:')
        console.log(`
-- Crear tabla users (SIN campo institution)
CREATE TABLE IF NOT EXISTS users (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  full_name VARCHAR(255) NOT NULL,
  password_hash VARCHAR(255),
  avatar_url TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Crear tabla projects
CREATE TABLE IF NOT EXISTS projects (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  status VARCHAR(50) DEFAULT 'planning',
  owner_id UUID REFERENCES users(id) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Crear tabla project_members (sin campo role)
CREATE TABLE IF NOT EXISTS project_members (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  joined_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(project_id, user_id)
);

-- Crear √≠ndices
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_projects_owner ON projects(owner_id);
CREATE INDEX IF NOT EXISTS idx_projects_status ON projects(status);

-- Insertar datos de ejemplo
INSERT INTO users (email, full_name) VALUES 
('investigador@ejemplo.com', 'Dr. Investigador Principal'),
('investigador2@universidad.edu', 'Dra. Mar√≠a Garc√≠a'),
('investigador3@instituto.org', 'Dr. Juan P√©rez')
ON CONFLICT (email) DO NOTHING;
        `)
        
        console.log('\nüåê Despu√©s de ejecutar el SQL, las tablas estar√°n listas para usar.')
        return false
      } else {
        console.error('‚ùå Error de conexi√≥n:', error)
        return false
      }
    } else {
      console.log('‚úÖ Conexi√≥n exitosa con Supabase')
      console.log('‚úÖ Tabla users existe y tiene datos:', data?.length || 0, 'registros')
      
      // Verificar proyectos
      const { data: projects } = await supabase
        .from('projects')
        .select('*')
        .limit(1)
      
      if (projects) {
        console.log('‚úÖ Tabla projects existe y tiene:', projects.length, 'registros')
      }
      
      return true
    }
  } catch (error) {
    console.error('‚ùå Error inesperado:', error)
    return false
  }
}

async function createSampleProject() {
  console.log('\nüìã Creando proyecto de ejemplo...')
  
  try {
    // Obtener un usuario existente
    const { data: users } = await supabase
      .from('users')
      .select('id')
      .limit(1)
    
    if (!users || users.length === 0) {
      console.log('‚ùå No hay usuarios disponibles para crear el proyecto')
      return
    }
    
    const userId = users[0].id
    
    // Crear proyecto de ejemplo
    const { data: project, error: projectError } = await supabase
      .from('projects')
      .insert([
        {
          title: 'Revisi√≥n Sistem√°tica de IA en Educaci√≥n',
          description: 'Una revisi√≥n sistem√°tica sobre el uso de inteligencia artificial en procesos educativos',
          status: 'planning',
          owner_id: userId
        }
      ])
      .select()
      .single()
    
    if (projectError) {
      console.error('‚ùå Error al crear proyecto:', projectError)
    } else {
      console.log('‚úÖ Proyecto de ejemplo creado:', project.title)
      console.log('   üìä ID:', project.id)
      console.log('   üìù Estado:', project.status)
    }
  } catch (error) {
    console.error('‚ùå Error:', error)
  }
}

// Ejecutar verificaciones
async function main() {
  const isConnected = await testSupabaseConnection()
  
  if (isConnected) {
    await createSampleProject()
    
    console.log('\nüéâ ¬°Base de datos lista para usar!')
    console.log('üì± Puedes ejecutar: npm run dev')
  }
}

main().catch(console.error)