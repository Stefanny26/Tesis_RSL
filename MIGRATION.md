# Gu√≠a de Migraci√≥n a Clean Architecture

## üéØ Estado Actual

‚úÖ **Completado:**
- Estructura base de Clean Architecture creada
- Entidades del dominio: `User`, `Project`, `Reference`
- Interfaces de repositorios: `IAuthRepository`, `IProjectRepository`, `IReferenceRepository`
- Casos de uso de autenticaci√≥n implementados
- Repositorios de infraestructura: `LocalStorageAuthRepository`, `InMemoryProjectRepository`
- `lib/auth-context.tsx` migrado a Clean Architecture (sin romper compatibilidad)

‚è≥ **Pendiente:**
- Migrar gesti√≥n de proyectos
- Migrar gesti√≥n de referencias
- Migrar screening y PRISMA
- Agregar tests unitarios
- Implementar integraci√≥n con Supabase
- Agregar value objects para validaciones avanzadas

## üìã Pasos para Continuar la Migraci√≥n

### 1. Migrar Proyectos (Alta Prioridad)

#### 1.1 Crear Casos de Uso para Proyectos

Crear en `src/application/use-cases/projects/`:

```typescript
// CreateProjectUseCase.ts
export class CreateProjectUseCase {
  constructor(private projectRepository: IProjectRepository) {}
  
  async execute(data: CreateProjectDTO): Promise<Project> {
    // Validaciones de negocio
    // Llamar al repositorio
  }
}

// GetProjectsUseCase.ts
// GetProjectByIdUseCase.ts
// UpdateProjectUseCase.ts
// DeleteProjectUseCase.ts
// AddCollaboratorUseCase.ts
```

#### 1.2 Actualizar Componentes

- `components/dashboard/create-project-dialog.tsx` ‚Üí Usar `CreateProjectUseCase`
- `components/dashboard/project-card.tsx` ‚Üí Mostrar datos de la entidad `Project`
- `app/dashboard/page.tsx` ‚Üí Usar `GetProjectsUseCase`

### 2. Migrar Referencias (Alta Prioridad)

#### 2.1 Crear Implementaci√≥n del Repositorio

```typescript
// src/infrastructure/repositories/InMemoryReferenceRepository.ts
export class InMemoryReferenceRepository implements IReferenceRepository {
  // Implementar usando mockReferences de lib/mock-references.ts
}
```

#### 2.2 Crear Casos de Uso

Crear en `src/application/use-cases/references/`:

```typescript
// ImportReferencesUseCase.ts
// GetReferencesByProjectUseCase.ts
// UpdateReferenceStatusUseCase.ts
// SearchReferencesUseCase.ts
// ExportReferencesUseCase.ts
```

#### 2.3 Actualizar Componentes

- `components/screening/reference-table.tsx` ‚Üí Usar casos de uso
- `components/screening/ai-screening-panel.tsx` ‚Üí Usar casos de uso

### 3. Migrar Protocolo y PRISMA (Media Prioridad)

#### 3.1 Crear Entidades Adicionales

```typescript
// src/domain/entities/Protocol.ts
// src/domain/entities/PrismaItem.ts
```

#### 3.2 Crear Repositorios e Interfaces

```typescript
// src/domain/repositories/IProtocolRepository.ts
// src/infrastructure/repositories/InMemoryProtocolRepository.ts
```

#### 3.3 Crear Casos de Uso

```typescript
// src/application/use-cases/protocol/CreateProtocolUseCase.ts
// src/application/use-cases/protocol/UpdateProtocolUseCase.ts
// src/application/use-cases/prisma/ValidatePrismaComplianceUseCase.ts
```

### 4. Servicios Externos (Media Prioridad)

#### 4.1 Crear Interfaces de Servicios

```typescript
// src/domain/services/IAIService.ts
export interface IAIService {
  generateScreeningSuggestion(reference: Reference): Promise<string>
  validatePrismaItem(item: PrismaItem): Promise<ValidationResult>
  generateArticleSection(context: ArticleContext): Promise<string>
}
```

#### 4.2 Implementar Adaptadores

```typescript
// src/infrastructure/services/OpenAIService.ts
export class OpenAIService implements IAIService {
  // Implementaci√≥n con OpenAI API
}

// src/infrastructure/services/MockAIService.ts
export class MockAIService implements IAIService {
  // Implementaci√≥n mock para desarrollo
}
```

### 5. Integraci√≥n con Supabase (Alta Prioridad)

#### 5.1 Instalar Dependencias

```bash
pnpm add @supabase/supabase-js
```

#### 5.2 Crear Cliente de Supabase

```typescript
// src/infrastructure/database/supabase-client.ts
import { createClient } from '@supabase/supabase-js'

export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)
```

#### 5.3 Implementar Repositorios con Supabase

```typescript
// src/infrastructure/repositories/SupabaseAuthRepository.ts
export class SupabaseAuthRepository implements IAuthRepository {
  async login(credentials: LoginCredentials): Promise<User> {
    const { data, error } = await supabase.auth.signInWithPassword({
      email: credentials.email,
      password: credentials.password,
    })
    
    if (error) throw error
    
    // Convertir a entidad del dominio
    return this.mapToUser(data.user)
  }
  
  async loginWithGoogle(): Promise<User> {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
    })
    
    if (error) throw error
    return this.mapToUser(data.user)
  }
  
  // ... otros m√©todos
}
```

#### 5.4 Actualizar el Provider

```typescript
// lib/auth-context.tsx
// Cambiar de LocalStorageAuthRepository a SupabaseAuthRepository
const authRepository = new SupabaseAuthRepository()
```

### 6. Testing (Alta Prioridad)

#### 6.1 Instalar Dependencias de Testing

```bash
pnpm add -D vitest @testing-library/react @testing-library/jest-dom
```

#### 6.2 Crear Tests para Entidades

```typescript
// src/domain/entities/__tests__/User.test.ts
describe('User Entity', () => {
  it('should create a valid user', () => {
    const user = new User({
      id: '1',
      email: 'test@example.com',
      name: 'Test User',
      role: 'researcher',
    })
    
    expect(user.email).toBe('test@example.com')
    expect(user.canCreateProject()).toBe(true)
  })
  
  it('should throw error for invalid email', () => {
    expect(() => {
      new User({
        id: '1',
        email: 'invalid-email',
        name: 'Test',
        role: 'researcher',
      })
    }).toThrow('Valid email is required')
  })
})
```

#### 6.3 Crear Tests para Casos de Uso

```typescript
// src/application/use-cases/auth/__tests__/LoginUseCase.test.ts
describe('LoginUseCase', () => {
  it('should login user with valid credentials', async () => {
    const mockRepo = new MockAuthRepository()
    const useCase = new LoginUseCase(mockRepo)
    
    const user = await useCase.execute({
      email: 'test@example.com',
      password: 'password123',
    })
    
    expect(user.email).toBe('test@example.com')
  })
  
  it('should throw error for empty email', async () => {
    const mockRepo = new MockAuthRepository()
    const useCase = new LoginUseCase(mockRepo)
    
    await expect(
      useCase.execute({ email: '', password: 'pass' })
    ).rejects.toThrow('El email es requerido')
  })
})
```

#### 6.4 Crear Mock Repositories para Testing

```typescript
// src/infrastructure/repositories/__mocks__/MockAuthRepository.ts
export class MockAuthRepository implements IAuthRepository {
  private users: User[] = []
  
  async login(credentials: LoginCredentials): Promise<User> {
    const user = this.users.find(u => u.email === credentials.email)
    if (!user) throw new Error('User not found')
    return user
  }
  
  // ... otros m√©todos mock
}
```

### 7. Value Objects (Media Prioridad)

Crear objetos de valor para validaciones m√°s robustas:

```typescript
// src/domain/value-objects/Email.ts
export class Email {
  private readonly value: string
  
  constructor(email: string) {
    if (!this.isValid(email)) {
      throw new Error('Invalid email format')
    }
    this.value = email
  }
  
  private isValid(email: string): boolean {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)
  }
  
  toString(): string {
    return this.value
  }
}

// src/domain/value-objects/Password.ts
export class Password {
  private readonly value: string
  
  constructor(password: string) {
    if (password.length < 8) {
      throw new Error('Password must be at least 8 characters')
    }
    this.value = password
  }
  
  toString(): string {
    return this.value
  }
}
```

## üîÑ Proceso de Migraci√≥n Recomendado

### Para Cada Feature:

1. **Identificar Dependencias**
   - ¬øQu√© componentes usa?
   - ¬øQu√© datos necesita?
   - ¬øQu√© operaciones realiza?

2. **Crear Entidades del Dominio**
   - Definir propiedades
   - Agregar validaciones
   - Agregar m√©todos de negocio

3. **Crear Interfaces de Repositorio**
   - Definir operaciones CRUD
   - Definir operaciones de b√∫squeda

4. **Implementar Repositorio**
   - Empezar con InMemory/LocalStorage
   - Luego migrar a Supabase

5. **Crear Casos de Uso**
   - Un caso de uso por operaci√≥n
   - Agregar validaciones de negocio
   - Mantener casos de uso simples y enfocados

6. **Actualizar Componentes**
   - Instanciar repositorios y casos de uso
   - Reemplazar l√≥gica directa por llamadas a casos de uso
   - Mantener componentes agn√≥sticos del origen de datos

7. **Escribir Tests**
   - Tests unitarios para entidades
   - Tests unitarios para casos de uso
   - Tests de integraci√≥n para repositorios

8. **Validar**
   - Verificar que la funcionalidad sigue funcionando
   - Verificar que no hay regresiones
   - Validar con el usuario final

## üìù Checklist de Migraci√≥n

### Por Feature:

- [ ] Entidad del dominio creada
- [ ] Interface de repositorio definida
- [ ] Repositorio implementado (mock/real)
- [ ] Casos de uso creados
- [ ] Componentes actualizados
- [ ] Tests escritos
- [ ] Documentaci√≥n actualizada
- [ ] Code review completado
- [ ] Funcionalidad validada

### Features Pendientes:

#### Gesti√≥n de Proyectos
- [ ] CreateProject
- [ ] UpdateProject
- [ ] DeleteProject
- [ ] GetProjects
- [ ] AddCollaborator
- [ ] RemoveCollaborator

#### Gesti√≥n de Referencias
- [ ] ImportReferences
- [ ] UpdateReferenceStatus
- [ ] SearchReferences
- [ ] ExportReferences
- [ ] DetectDuplicates

#### Screening
- [ ] ScreenReference
- [ ] BulkScreening
- [ ] AIScreeningSuggestion
- [ ] ApplyFilters

#### Protocolo
- [ ] CreateProtocol
- [ ] UpdateProtocol
- [ ] ValidateProtocol

#### PRISMA
- [ ] UpdatePrismaItem
- [ ] ValidatePrismaCompliance
- [ ] GeneratePrismaReport

#### Exportaci√≥n
- [ ] ExportArticle
- [ ] ExportReferences
- [ ] GeneratePrismaFlowDiagram
- [ ] GenerateProjectReport

#### Art√≠culo
- [ ] CreateArticle
- [ ] UpdateArticleSection
- [ ] GenerateWithAI
- [ ] ManageVersions

## üöÄ Comandos √ötiles

### Desarrollo
```bash
# Iniciar servidor de desarrollo
pnpm dev

# Verificar tipos TypeScript
pnpm tsc --noEmit

# Ejecutar linter
pnpm lint

# Ejecutar tests
pnpm test

# Ejecutar tests en modo watch
pnpm test:watch
```

### Build
```bash
# Build de producci√≥n
pnpm build

# Iniciar en producci√≥n
pnpm start
```

## üìö Recursos Adicionales

- [Clean Architecture - Robert C. Martin](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- [Domain-Driven Design](https://martinfowler.com/tags/domain%20driven%20design.html)
- [Testing Clean Architecture](https://www.jamesshore.com/v2/projects/nullables/testing-without-mocks)
- [Supabase Documentation](https://supabase.com/docs)
- [Next.js Documentation](https://nextjs.org/docs)

## ‚ùì Preguntas Frecuentes

### ¬øPor qu√© usar Clean Architecture?

- **Testeable**: Puedes testear la l√≥gica de negocio sin UI o BD
- **Mantenible**: C√≥digo organizado y f√°cil de entender
- **Flexible**: F√°cil cambiar de BD, framework o servicio externo
- **Escalable**: Agregar nuevas features es directo

### ¬øCu√°ndo NO usar Clean Architecture?

- Proyectos muy peque√±os (< 5 pantallas)
- Prototipos r√°pidos
- Proyectos con deadline muy ajustado
- Cuando el equipo no est√° familiarizado (requiere capacitaci√≥n)

### ¬øC√≥mo convencer al equipo?

- Mostrar tests automatizados funcionando
- Demostrar facilidad de cambiar de BD (LocalStorage ‚Üí Supabase)
- Mostrar facilidad de agregar nuevas features
- Comparar mantenibilidad con c√≥digo "legacy"

## üéØ Pr√≥ximos Pasos Inmediatos

1. **Terminar migraci√≥n de Auth** ‚úÖ (Completado)
2. **Migrar gesti√≥n de Proyectos** ‚Üê Siguiente
3. **Migrar gesti√≥n de Referencias**
4. **Agregar tests unitarios b√°sicos**
5. **Implementar Supabase**
6. **Migrar features avanzadas (AI, PRISMA, Export)**

---

**√öltima actualizaci√≥n**: 27 de Octubre, 2025
**Autor**: Sistema de Migraci√≥n Clean Architecture
**Versi√≥n**: 1.0.0
